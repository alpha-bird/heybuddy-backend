machine:
    services:
        - docker
    python:
        version: 2.7.11

dependencies:
    override:
        - pip install docker-compose
        - sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 36A1D7869245C8950F966E92D8576A8BA88D21E9
        - sudo sh -c "echo deb https://get.docker.io/ubuntu docker main > /etc/apt/sources.list.d/docker.list"
        - sudo apt-get update
        - sudo apt-get install lxc-docker
        - sudo service docker start
        - docker --version
        - docker-compose --version
        - docker build --rm=false -t heybuddy .
        #- docker login -e alpha.birdprime@gmail.com -u alphabird727 -p 'ghost123!@#'
        - echo "Ignoring default CircleCI dependencies"

test:
  override:
    - echo "Skipping tests" # docker-compose run test

deployment:
  hub:
    branch: master
    commands:
        #- docker push heybuddy:latest
        - echo '-----BEGIN CERTIFICATE-----' >> ca.pem
            && echo $DOCKER_PROD_CAPEM | sed -e 's/\s\+/\n/g' >> ca.pem
            && echo '-----END CERTIFICATE-----' >> ca.pem
            && touch $DOCKER_CERT_PATH/ca.pem
            && mv ca.pem $DOCKER_CERT_PATH/ca.pem
        - echo export DOCKER_TLS_VERIFY=$(echo $DOCKER_TLS_VERIFY_PROD) >> ~/.circlerc
        - echo export DOCKER_HOST=$(echo $DOCKER_HOST_PROD) >> ~/.circlerc
        - echo export DOCKER_CERT_PATH=$(echo $DOCKER_CERT_PATH_PROD) >> ~/.circlerc
        #- docker pull heybuddy:latest
        - git clone git@github.com:alpha-bird/heybuddy-backend.git
        - docker-compose -f heybuddy-backend/docker-compose.yml up -d
        - docker images --no-trunc | grep none | awk '{print $3}' | xargs docker rmi
